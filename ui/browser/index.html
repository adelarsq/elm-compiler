<!doctype html>

<html>

<head>
  <meta charset="utf-8">
  <title>Elm -> Wasm test</title>
  <style>
    body {
      background-color: #222;
      color: lightgrey;
      font-family: courier;
    }

    table {
      border-collapse: collapse;
    }

    td {
      border: 1px gray solid;
      padding: 4px;
      text-align: center;
      margin: auto;
    }

    .changed {
      color: red;
      font-weight: bold;
    }

    .i32aligned {
      border-top: 2px solid;
    }

    .addr {
      color: #666;
    }
  </style>
</head>

<body>
  <table id="results">

  </table>

  <script>

    const globals = [
      "heapTop",
      "add",
      "outerScopeValue",
      "closure",
      "curried",
      "main",
    ];

    WebAssembly
      .instantiateStreaming(fetch('elm.wasm'))
      .then(wasm => {

        /*
            SETUP
        */
        const memory = wasm.instance.exports.memory;
        const buf = new Uint8Array(memory.buffer);

        const beforeTmp = buf.slice();


        /*
            RUN
        */
        const exp = wasm.instance.exports;
        exp.start();


        /*
            ANALYSE
        */
        const addrToGlobalNames = globals.reduce(
          (addrMap, name) => {
            const addr = exp[name]();
            addrMap[addr] = addrMap[addr] || [];
            addrMap[addr].push(name);
            return addrMap;
          },
          {}
        );

        let maxAddr = 1024;
        while (buf[maxAddr] === 0) maxAddr--;
        maxAddr += 4;

        const before = beforeTmp.slice(0, maxAddr);
        const after = buf.slice(0, maxAddr);


        /*
            DISPLAY
        */
        let html = '';
        for (let addr = 0; addr < maxAddr; addr++) {

          // Globals at this address
          const globalNames = addrToGlobalNames[addr] || [];

          // Styling
          let rowClasses = [];
          if (before[addr] !== after[addr]) {
            rowClasses.push('changed');
          }
          if (addr % 4 === 0) {
            rowClasses.push('i32aligned')
          }
          let classStr = rowClasses.length
            ? `class="${rowClasses.join(' ')}"`
            : '';


          html += `<tr ${classStr}>
                    <td class="addr">${addr}</td>
                    <td>${before[addr]}</td>
                    <td>${after[addr]}</td>
                    <td>${globalNames.join(', ')}</td>
                  </tr>`;
        }
        const table = document.getElementById('results');
        table.innerHTML = html;

      });

  </script>
</body>

</html>